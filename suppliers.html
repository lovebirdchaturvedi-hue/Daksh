<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Admin â€“ Supplier Management</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="assets/admin.css">

<style>
.main{
  padding:40px;
}
table{
  width:100%;
  border-collapse:collapse;
  background:#fff;
}
th,td{
  padding:12px;
  border-bottom:1px solid #e5e7eb;
  text-align:left;
}
th{
  background:#020617;
  color:#fff;
}
button{
  padding:6px 12px;
  border-radius:6px;
  border:none;
  cursor:pointer;
}
.approve{background:#16a34a;color:#fff}
.reject{background:#dc2626;color:#fff}
</style>
</head>

<body>

<!-- SIDEBAR -->
<div class="sidebar">
  <h2>APD Admin</h2>
  <a href="dashboard.html">Dashboard</a>
  <a href="rfqs.html">RFQs</a>
  <a href="suppliers.html" class="active">Suppliers</a>
  <button class="logout" id="logoutBtn">Logout</button>
</div>

<!-- MAIN -->
<div class="main">
  <h1>Supplier Management</h1>

  <table>
    <thead>
      <tr>
        <th>Company</th>
        <th>Email</th>
        <th>Status</th>
        <th>Plan</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody id="supplierTable">
      <tr>
        <td colspan="5">Loading suppliersâ€¦</td>
      </tr>
    </tbody>
  </table>
</div>

<script type="module">
import { auth, db } from "/assets/js/firebase-init.js";
import {
  onAuthStateChanged,
  signOut
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import {
  collection,
  getDocs,
  updateDoc,
  doc,
  getDoc
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const table = document.getElementById("supplierTable");
const logoutBtn = document.getElementById("logoutBtn");

/* ðŸ” ADMIN GUARD */
onAuthStateChanged(auth, async (user) => {
  if (!user) {
    window.location.replace("/supplier-login.html");
    return;
  }

  // âœ… ADMIN CHECK (SINGULAR COLLECTION)
  const adminSnap = await getDoc(doc(db, "admin", user.uid));
  if (!adminSnap.exists()) {
    window.location.replace("/rfq.html");
    return;
  }

  loadSuppliers();
});

/* ðŸ“¦ LOAD SUPPLIERS */
async function loadSuppliers() {
  table.innerHTML = "";

  const snap = await getDocs(collection(db, "suppliers"));

  if (snap.empty) {
    table.innerHTML = `
      <tr>
        <td colspan="5">No suppliers found</td>
      </tr>`;
    return;
  }

  snap.forEach(d => {
    const s = d.data();

    table.innerHTML += `
      <tr>
        <td>${s.companyName || "-"}</td>
        <td>${s.email || "-"}</td>
        <td><strong>${s.status || "-"}</strong></td>
        <td>${s.plan || "basic"}</td>
        <td>
          <button class="approve"
            onclick="updateStatus('${d.id}','approved')">
            Approve
          </button>
          <button class="reject"
            onclick="updateStatus('${d.id}','rejected')">
            Reject
          </button>
        </td>
      </tr>
    `;
  });
}

/* ðŸ” UPDATE STATUS */
window.updateStatus = async (id, status) => {
  if (!confirm("Are you sure?")) return;

  await updateDoc(doc(db, "suppliers", id), { status });
  alert("Supplier " + status);
  loadSuppliers();
};

/* ðŸšª LOGOUT */
logoutBtn.onclick = async () => {
  await signOut(auth);
  window.location.replace("/supplier-login.html");
};
</script>

</body>
</html>
